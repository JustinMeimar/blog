---
import Base from "./Base.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Comments from "../components/Comments.astro";
import { formatDate } from "../utils/posts";

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description: string;
  publishDate: Date;
  updatedDate?: Date;
  tags?: string[];
  ogImage?: string;
  minutesRead?: string;
  headings?: Heading[];
  activeSection?: 'writing' | 'projects' | 'til';
}

const { title, description, publishDate, updatedDate, tags = [], ogImage, minutesRead, headings = [], activeSection = 'writing' } = Astro.props;

const showToc = headings.length > 3;
---

<Base 
  title={`${title} — justinmeimar`} 
  description={description} 
  ogImage={ogImage}
  type="article"
  publishedTime={publishDate}
  modifiedTime={updatedDate}
  tags={tags}
>
  {/* Mobile sticky header - only shows when scrolled past article header */}
  {showToc && (
    <div id="mobile-toc-bar" class="fixed top-0 left-0 right-0 z-40 lg:hidden translate-y-[-100%] pointer-events-none transition-transform duration-300 ease-out">
      <button 
        id="mobile-toc-trigger"
        class="w-full px-3 py-1.5 flex items-center justify-between text-left bg-[var(--bg-paper)] border-y border-[var(--border)] relative overflow-hidden"
      >
        {/* Progress bar background */}
        <div id="reading-progress" class="absolute inset-0 bg-[var(--accent-pop)]/15 w-0 transition-[width] duration-150 pointer-events-none"></div>
        <span id="current-section" class="font-mono text-[10px] text-[var(--text-muted)] truncate pr-2 relative z-10">
          {headings[0]?.text || title}
        </span>
        <svg id="mobile-toc-chevron" class="w-3.5 h-3.5 text-[var(--text-muted)] shrink-0 transition-transform duration-200 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      {/* Dropdown TOC */}
      <div id="mobile-toc-dropdown" class="bg-[var(--bg-paper)] border-b border-[var(--border)] overflow-hidden opacity-0 max-h-0 transition-all duration-200 ease-out">
        <ul class="px-3 py-1.5">
          {headings.map((heading) => (
            <li>
<a
                href={`#${heading.slug}`}
                class={`mobile-toc-link block py-1.5 px-2 -mx-2 rounded font-mono transition-all ${
                  heading.depth === 2 
                    ? 'text-xs text-[var(--text-muted)]' 
                    : 'text-[11px] text-[var(--text-faint)] pl-5'
                }`}
                data-slug={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
  )}

  <div class={`mx-auto px-6 py-12 md:py-20 topo-mask ${showToc ? 'max-w-6xl' : 'max-w-3xl'}`}>
    <Header activeSection={activeSection} />

    <div class={showToc ? 'lg:grid lg:grid-cols-[1fr_220px] lg:gap-12' : ''}>
    <article class="animate-fade-up stagger-1 max-w-3xl" data-pagefind-body>
      <!-- Post header -->
      <header class="mb-12" data-pagefind-ignore>
        <div class="flex items-baseline gap-4 mb-4 font-mono text-xs text-[var(--text-muted)]">
          <time datetime={publishDate.toISOString()}>
            {formatDate(publishDate)}
          </time>
          {
            minutesRead && (
              <>
                <span class="text-[var(--text-faint)]">·</span>
                <span>{minutesRead}</span>
              </>
            )
          }
          {
            updatedDate && (
              <>
                <span class="text-[var(--text-faint)]">·</span>
                <span>Updated {formatDate(updatedDate)}</span>
              </>
            )
          }
        </div>

        <h1 class="font-serif text-3xl md:text-4xl font-normal tracking-tight mb-4">
          {title}
        </h1>

        <p class="font-serif text-lg text-[var(--text-muted)] leading-relaxed">
          {description}
        </p>

        {
          tags.length > 0 && (
            <div class="mt-6 flex flex-wrap gap-2">
              {tags.map((tag) => (
                <a
                  href={`/tags/${tag}`}
                  class="font-mono text-xs px-2 py-1 rounded bg-[var(--bg-paper)] text-[var(--text-muted)] hover:text-[var(--text)] transition-colors"
                >
                  #{tag}
                </a>
              ))}
            </div>
          )
        }
      </header>

      <!-- Divider -->
      <div class="mb-12 h-px bg-[var(--border)]"></div>

      <!-- Post content -->
      <div class="prose">
        <slot />
      </div>

      <!-- Post footer -->
      <footer class="mt-16" data-pagefind-ignore>
        <div class="h-px bg-[var(--border)] mb-12"></div>

        <!-- Back to posts -->
        <a
          href={activeSection === 'til' ? '/til' : '/posts'}
          class="inline-flex items-center gap-2 font-mono text-xs text-[var(--text-muted)] hover:text-[var(--text)] transition-colors"
        >
          <span>←</span>
          <span>Back to all {activeSection === 'til' ? 'TILs' : 'posts'}</span>
        </a>

        <!-- Comments -->
        <div class="mt-12">
          <h2 class="font-mono text-xs tracking-widest uppercase text-[var(--text-muted)] mb-6">
            Comments
          </h2>
          <Comments />
        </div>
      </footer>
    </article>

    {/* Table of Contents - sticky sidebar */}
    {showToc && (
      <aside class="hidden lg:block" data-pagefind-ignore>
        <nav class="sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto overscroll-contain toc-scroll">
          <h2 class="font-mono text-[10px] tracking-widest uppercase text-[var(--text-faint)] mb-3 pt-8">
            On this page
          </h2>
          <ul class="border-l border-[var(--border)] text-sm" id="toc">
            {headings.map((heading) => (
              <li>
                <a
                  href={`#${heading.slug}`}
                  class={`toc-link block py-1 pl-3 -ml-px border-l border-transparent hover:border-[var(--text-faint)] transition-colors font-mono leading-snug ${
                    heading.depth === 2 
                      ? 'text-[12px] text-[var(--text-muted)]' 
                      : 'text-[11px] text-[var(--text-faint)] pl-5'
                  }`}
                  data-slug={heading.slug}
                  data-depth={heading.depth}
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}
    </div>

    <div class="mt-16 max-w-3xl">
      <Footer />
    </div>
  </div>

  {/* TOC highlight script */}
  {showToc && (
    <script>
      let cleanupToc: (() => void) | null = null;

      function initToc() {
        // Cleanup previous instance
        cleanupToc?.();

        const tocLinks = document.querySelectorAll('.toc-link');
        const mobileTocLinks = document.querySelectorAll('.mobile-toc-link');
        const headings = Array.from(tocLinks).map(link => {
          const slug = link.getAttribute('data-slug');
          return document.getElementById(slug!);
        }).filter(Boolean) as HTMLElement[];

        // Mobile TOC elements
        const mobileBar = document.getElementById('mobile-toc-bar');
        const mobileTrigger = document.getElementById('mobile-toc-trigger');
        const mobileDropdown = document.getElementById('mobile-toc-dropdown');
        const mobileChevron = document.getElementById('mobile-toc-chevron');
        const currentSection = document.getElementById('current-section');
        const progressBar = document.getElementById('reading-progress');
        
        // Get article header for visibility detection
        const articleHeader = document.querySelector('article header');
        let isDropdownOpen = false;
        let scrollTicking = false;

        function handleOutsideClick(e: MouseEvent) {
          if (mobileBar && !mobileBar.contains(e.target as Node)) {
            closeDropdown();
          }
        }

        function scrollToActiveLink() {
          const activeLink = mobileDropdown?.querySelector('.mobile-toc-link[data-active="true"]');
          if (activeLink) {
            activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }
        }

        function handleTransitionEnd(e: TransitionEvent) {
          if (e.propertyName === 'max-height' && isDropdownOpen) {
            scrollToActiveLink();
          }
        }

        // Add transitionend listener once
        mobileDropdown?.addEventListener('transitionend', handleTransitionEnd);

        function openDropdown() {
          if (!mobileDropdown || isDropdownOpen) return;
          isDropdownOpen = true;
          mobileDropdown.classList.remove('max-h-0', 'opacity-0', 'overflow-hidden');
          mobileDropdown.classList.add('max-h-[50vh]', 'opacity-100', 'overflow-y-auto');
          mobileChevron?.classList.add('rotate-180');
          // Delay adding click listener to avoid catching the current click event
          requestAnimationFrame(() => {
            document.addEventListener('click', handleOutsideClick);
          });
        }

        function closeDropdown() {
          if (!mobileDropdown || !isDropdownOpen) return;
          isDropdownOpen = false;
          mobileDropdown.classList.add('max-h-0', 'opacity-0', 'overflow-hidden');
          mobileDropdown.classList.remove('max-h-[50vh]', 'opacity-100', 'overflow-y-auto');
          mobileChevron?.classList.remove('rotate-180');
          document.removeEventListener('click', handleOutsideClick);
        }

        function haptic() {
          try {
            const label = document.createElement('label');
            label.style.display = 'none';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.setAttribute('switch', '');
            label.appendChild(input);
            label.addEventListener('click', (e) => e.stopPropagation());
            document.head.appendChild(label);
            label.click();
            document.head.removeChild(label);
          } catch {}
        }

        function handleTriggerClick(e: Event) {
          e.stopPropagation();
          haptic();
          if (isDropdownOpen) {
            closeDropdown();
          } else {
            openDropdown();
          }
        }

        function handleMobileLinkClick() {
          closeDropdown();
        }

        // Toggle dropdown
        mobileTrigger?.addEventListener('click', handleTriggerClick);

        // Close dropdown when clicking a link
        mobileTocLinks.forEach(link => {
          link.addEventListener('click', handleMobileLinkClick);
        });

        function updateActiveLink() {
          const scrollPos = window.scrollY + 120;
          
          let activeIndex = 0;
          for (let i = 0; i < headings.length; i++) {
            if (headings[i].offsetTop <= scrollPos) {
              activeIndex = i;
            }
          }

          // Update desktop TOC
          tocLinks.forEach((link, i) => {
            const depth = link.getAttribute('data-depth');
            const isH2 = depth === '2';
            
            if (i === activeIndex) {
              link.classList.remove('text-[var(--text-faint)]', 'text-[var(--text-muted)]', 'border-transparent');
              link.classList.add('!text-[var(--accent-pop)]', '!border-[var(--accent-pop)]');
            } else {
              link.classList.remove('!text-[var(--accent-pop)]', '!border-[var(--accent-pop)]');
              link.classList.add('border-transparent');
              if (isH2) {
                link.classList.add('text-[var(--text-muted)]');
                link.classList.remove('text-[var(--text-faint)]');
              } else {
                link.classList.add('text-[var(--text-faint)]');
                link.classList.remove('text-[var(--text-muted)]');
              }
            }
          });

          // Update mobile TOC
          mobileTocLinks.forEach((link, i) => {
            if (i === activeIndex) {
              link.classList.add('!text-[var(--accent-pop)]', 'bg-[var(--accent-pop)]/10');
              link.setAttribute('data-active', 'true');
            } else {
              link.classList.remove('!text-[var(--accent-pop)]', 'bg-[var(--accent-pop)]/10');
              link.removeAttribute('data-active');
            }
          });

          // Update current section text
          if (currentSection && headings[activeIndex]) {
            const heading = headings[activeIndex];
            currentSection.textContent = heading.textContent || '';
          }

          // Show/hide mobile bar based on scroll position
          if (mobileBar && articleHeader) {
            const headerBottom = articleHeader.getBoundingClientRect().bottom;
            if (headerBottom < 0) {
              mobileBar.classList.remove('translate-y-[-100%]', 'pointer-events-none');
            } else {
              mobileBar.classList.add('translate-y-[-100%]', 'pointer-events-none');
              // Close dropdown when bar hides
              if (isDropdownOpen) {
                closeDropdown();
              }
            }
          }

          // Update progress bar
          if (progressBar) {
            const article = document.querySelector('article');
            if (article) {
              const articleTop = article.offsetTop;
              const articleHeight = article.offsetHeight;
              const windowHeight = window.innerHeight;
              const scrolled = window.scrollY - articleTop + windowHeight;
              const progress = Math.min(Math.max(scrolled / articleHeight * 100, 0), 100);
              progressBar.style.width = `${progress}%`;
            }
          }

          // Scroll active link into view within the desktop TOC
          const activeLink = tocLinks[activeIndex];
          if (activeLink) {
            const toc = document.getElementById('toc');
            if (toc) {
              const tocRect = toc.getBoundingClientRect();
              const linkRect = activeLink.getBoundingClientRect();
              if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
              }
            }
          }

          scrollTicking = false;
        }

        function handleScroll() {
          if (!scrollTicking) {
            requestAnimationFrame(updateActiveLink);
            scrollTicking = true;
          }
        }

        window.addEventListener('scroll', handleScroll, { passive: true });
        updateActiveLink();

        // Return cleanup function
        cleanupToc = () => {
          window.removeEventListener('scroll', handleScroll);
          document.removeEventListener('click', handleOutsideClick);
          mobileDropdown?.removeEventListener('transitionend', handleTransitionEnd);
          mobileTrigger?.removeEventListener('click', handleTriggerClick);
          mobileTocLinks.forEach(link => {
            link.removeEventListener('click', handleMobileLinkClick);
          });
          cleanupToc = null;
        };
      }

      // Run on initial load and after view transitions
      initToc();
      document.addEventListener('astro:after-swap', initToc);
      document.addEventListener('astro:before-swap', () => cleanupToc?.());
    </script>
  )}
</Base>
