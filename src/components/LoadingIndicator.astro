---
// Loading indicator for View Transitions
// Shows a progress bar at the top of the page during navigation
---

<div id="loading-indicator"></div>

<style is:global>
  #loading-indicator {
    position: fixed;
    top: 0;
    left: 0;
    height: 2px;
    width: 0%;
    background: #c44d4d;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
  }

  [data-theme="dark"] #loading-indicator {
    background: #4db88a;
  }

  #loading-indicator.loading {
    opacity: 1;
    animation: loading-progress 2s ease-out forwards;
  }

  @keyframes loading-progress {
    0% {
      width: 0%;
    }
    20% {
      width: 30%;
    }
    50% {
      width: 60%;
    }
    80% {
      width: 80%;
    }
    100% {
      width: 95%;
    }
  }

  #loading-indicator.complete {
    width: 100% !important;
    opacity: 0;
    transition:
      opacity 0.3s ease,
      width 0.1s ease;
  }
</style>

<script is:inline>
  (function () {
    // Only register once per page lifecycle
    if (window._loadingIndicatorInit) return;
    window._loadingIndicatorInit = true;

    function showLoading() {
      const el = document.getElementById("loading-indicator");
      if (el) {
        el.classList.remove("complete");
        el.style.width = "0%";
        // Force reflow
        void el.offsetWidth;
        el.classList.add("loading");
      }
    }

    function hideLoading() {
      const el = document.getElementById("loading-indicator");
      if (el) {
        el.classList.remove("loading");
        el.classList.add("complete");
        setTimeout(() => {
          el.classList.remove("complete");
          el.style.width = "0%";
        }, 300);
      }
    }

    document.addEventListener("astro:before-preparation", showLoading);
    document.addEventListener("astro:page-load", hideLoading);
  })();
</script>
