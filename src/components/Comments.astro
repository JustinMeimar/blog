---
// Giscus comments - dynamically loaded to work with View Transitions
---

<div class="giscus"></div>

<script is:inline>
  function loadGiscus() {
    const container = document.querySelector('.giscus');
    if (!container) return;

    // Remove old iframe on page transitions so it reloads for the new pathname
    const oldFrame = container.querySelector('iframe.giscus-frame');
    if (oldFrame) oldFrame.remove();

    // Also remove any leftover script tags
    const oldScript = container.querySelector('script');
    if (oldScript) oldScript.remove();

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const isProd = window.location.hostname === 'justinmeimar.com';
    const theme = isProd
      ? (isDark ? 'https://justinmeimar.com/css/giscus-dark.css' : 'https://justinmeimar.com/css/giscus-light.css')
      : (isDark ? 'dark' : 'light');

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'JustinMeimar/blog');
    script.setAttribute('data-repo-id', 'R_kgDORIq8qg');
    script.setAttribute('data-category', 'General');
    script.setAttribute('data-category-id', 'DIC_kwDORIq8qs4C28Oh');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-theme', theme);
    script.setAttribute('data-lang', 'en');
    script.setAttribute('crossorigin', 'anonymous');
    script.async = true;

    container.appendChild(script);
  }

  function updateGiscusTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const isProd = window.location.hostname === 'justinmeimar.com';
    const theme = isProd
      ? (isDark ? 'https://justinmeimar.com/css/giscus-dark.css' : 'https://justinmeimar.com/css/giscus-light.css')
      : (isDark ? 'dark' : 'light');
    const iframe = document.querySelector('iframe.giscus-frame');
    if (iframe) {
      iframe.contentWindow?.postMessage(
        { giscus: { setConfig: { theme } } },
        'https://giscus.app'
      );
    }
  }

  // Sync theme when toggled
  window.addEventListener('theme-changed', updateGiscusTheme);

  // Load on initial page and after view transitions
  loadGiscus();
  document.addEventListener('astro:after-swap', loadGiscus);
</script>
