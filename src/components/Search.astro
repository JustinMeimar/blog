---
// Search component using Pagefind
// Pagefind files are generated at build time
---

<div class="search-container">
  <button
    id="search-trigger"
    class="font-mono text-xs text-[var(--text-muted)] hover:text-[var(--text)] transition-colors flex items-center gap-2"
    aria-label="Search"
  >
    <span class="hidden sm:inline">Search</span>
    <kbd class="hidden sm:inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-[var(--bg-paper)] rounded text-[10px] text-[var(--text-faint)]">
      <span>âŒ˜</span>K
    </kbd>
    <svg
      class="sm:hidden w-4 h-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="1.5"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
  </button>

  <dialog id="search-dialog" class="search-dialog">
    <div class="search-backdrop" data-close></div>
    <div class="search-modal">
      <div class="search-input-wrapper">
        <svg
          class="search-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search..."
          autocomplete="off"
        />
        <kbd class="search-esc">ESC</kbd>
      </div>
      <div id="search-results" class="search-results">
        <div class="search-empty">Type to search...</div>
      </div>
    </div>
  </dialog>
</div>

<style is:global>
  .search-dialog {
    position: fixed;
    inset: 0;
    z-index: 50;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    border: none;
    background: transparent;
  }

  .search-dialog::backdrop {
    background: transparent;
  }

  .search-backdrop {
    position: fixed;
    inset: 0;
    background: var(--bg);
    opacity: 0.9;
    backdrop-filter: blur(8px);
  }

  .search-modal {
    position: fixed;
    top: 12vh;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 2rem);
    max-width: 36rem;
    background: var(--bg-paper);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden;
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    padding: 0 1rem;
    border-bottom: 1px solid var(--border);
  }

  .search-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--text-muted);
    flex-shrink: 0;
  }

  #search-input {
    flex: 1;
    padding: 1rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
  }

  #search-input::placeholder {
    color: var(--text-faint);
  }

  .search-esc {
    padding: 0.25rem 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: var(--text-faint);
    background: var(--bg);
    border-radius: 0.25rem;
    border: 1px solid var(--border);
  }

  .search-results {
    max-height: 60vh;
    overflow-y: auto;
    padding: 0.5rem 0;
  }

  .search-empty,
  .search-loading {
    padding: 2rem 1rem;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .search-result {
    display: block;
    padding: 0.75rem 1rem;
    text-decoration: none;
    color: inherit;
    transition: background-color 0.15s ease;
    border-bottom: 1px solid var(--border);
  }

  .search-result:last-child {
    border-bottom: none;
  }

  .search-result:hover {
    background: var(--bg);
  }

  .search-result-title {
    font-family: var(--font-serif);
    font-size: 0.9375rem;
    font-weight: 400;
    margin-bottom: 0.25rem;
    color: var(--text);
  }

  .search-result-excerpt {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-result-excerpt mark {
    background: transparent;
    color: var(--text);
    font-weight: 500;
  }

  .search-no-results {
    padding: 2rem 1rem;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
  }
</style>

<script is:inline>
  function initSearch() {
    const trigger = document.getElementById('search-trigger');
    const dialog = document.getElementById('search-dialog');
    const input = document.getElementById('search-input');
    const results = document.getElementById('search-results');
    const backdrop = dialog?.querySelector('[data-close]');

    if (!trigger || !dialog) return;

    // Load Pagefind dynamically
    async function loadPagefind() {
      if (window.pagefind) return window.pagefind;
      try {
        const pf = await import('/pagefind/pagefind.js');
        await pf.init();
        window.pagefind = pf;
        return pf;
      } catch (e) {
        return null;
      }
    }

    function openSearch() {
      dialog.showModal();
      input?.focus();
      loadPagefind();
    }

    function closeSearch() {
      dialog.close();
      if (input) input.value = '';
      if (results) results.innerHTML = '<div class="search-empty">Type to search...</div>';
    }

    let searchTimeout;
    async function performSearch(query) {
      if (!results) return;

      if (!query || query.length < 2) {
        results.innerHTML = '<div class="search-empty">Type to search...</div>';
        return;
      }

      const pf = await loadPagefind();
      if (!pf) {
        results.innerHTML = '<div class="search-empty">Search available after build</div>';
        return;
      }

      results.innerHTML = '<div class="search-loading">Searching...</div>';

      const search = await pf.search(query);
      const data = await Promise.all(
        search.results.slice(0, 6).map(r => r.data())
      );

      if (data.length === 0) {
        results.innerHTML = '<div class="search-no-results">No results found</div>';
        return;
      }

      results.innerHTML = data
        .map(item => {
          const title = item.meta?.title || 'Untitled';
          const url = item.url;
          const excerpt = item.excerpt || '';

          return `
            <a href="${url}" class="search-result">
              <div class="search-result-title">${title}</div>
              <div class="search-result-excerpt">${excerpt}</div>
            </a>
          `;
        })
        .join('');
    }

    trigger.addEventListener('click', openSearch);
    backdrop?.addEventListener('click', closeSearch);

    dialog.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSearch();
    });

    input?.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value;
      searchTimeout = window.setTimeout(() => performSearch(query), 200);
    });

    results?.addEventListener('click', (e) => {
      if (e.target.closest('.search-result')) closeSearch();
    });
  }

  // Global keyboard shortcut (only add once)
  if (!window._searchKeyboardInit) {
    window._searchKeyboardInit = true;
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        const dialog = document.getElementById('search-dialog');
        if (dialog?.open) {
          dialog.close();
        } else {
          dialog?.showModal();
          document.getElementById('search-input')?.focus();
        }
      }
    });
  }

  // Initialize on page load and after transitions
  initSearch();
  document.addEventListener('astro:page-load', initSearch);
</script>
