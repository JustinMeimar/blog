---
// Theme toggle button - pure Astro, no React needed
---

<button
  id="theme-toggle"
  class="font-mono text-sm tracking-wide px-3 py-1.5 rounded transition-all duration-300 bg-[var(--bg-paper)] text-[var(--text-muted)] hover:text-[var(--text)]"
  aria-label="Toggle theme"
>
  <span class="theme-icon"></span>
</button>

<script is:inline>
  function initThemeToggle() {
    const button = document.getElementById('theme-toggle');
    const icon = button?.querySelector('.theme-icon');
    if (!button || !icon) return;

    // Prevent duplicate listeners
    if (button.dataset.initialized) return;
    button.dataset.initialized = 'true';

    function updateIcon() {
      const theme = document.documentElement.getAttribute('data-theme');
      icon.textContent = theme === 'dark' ? '☀' : '☾';
      button.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateIcon();
      // Dispatch event for other components (like Giscus)
      window.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme: next } }));
    }

    updateIcon();
    button.addEventListener('click', toggleTheme);
  }

  // astro:page-load fires on initial load and after each navigation
  document.addEventListener('astro:page-load', initThemeToggle);
</script>
