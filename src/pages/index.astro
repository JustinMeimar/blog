---
import { render } from "astro:content";
import Base from "../layouts/Base.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import PostPreview from "../components/PostPreview.astro";
import { Image } from "astro:assets";
import { getAllPosts } from "../utils/posts";
import { getFeaturedProjects, formatAwards } from "../utils/projects";

const posts = await getAllPosts();
const recentPosts = posts.slice(0, 3);
const recentPostsWithReadingTime = await Promise.all(
  recentPosts.map(async (post) => {
    const { remarkPluginFrontmatter } = await render(post);
    return {
      ...post,
      minutesRead: remarkPluginFrontmatter.minutesRead,
    };
  })
);
const featuredProjects = await getFeaturedProjects();
---

<Base title="Justin Meimar" description="Justin Meimar's personal website and blog">
  <div class="max-w-2xl mx-auto px-6 py-12 md:py-20">
    <Header activeSection="home" />

    <!-- Introduction -->
    <section class="mb-12 animate-fade-up stagger-1">
      <p class="font-serif text-lg md:text-xl leading-relaxed font-light">
      Hi, I'm Justin. A first year Masters student at the University of
      Alberta studying JIT compilers.
      </p>
    </section>

    <!-- Divider -->
    <div class="mb-16 h-px bg-[var(--border)] animate-fade-in stagger-2"></div>

    <!-- Writing Section -->
    <section class="mb-20 animate-fade-up stagger-2">
      <a 
        href="/posts"
        class="group flex items-baseline justify-between mb-8 -mx-2 px-2 py-1 rounded transition-colors duration-200 hover:bg-[var(--bg-paper)]"
      >
        <h2
          class="font-mono text-xs tracking-widest uppercase text-[var(--text-muted)] group-hover:text-[var(--text)] transition-colors duration-200"
        >
          Recent Writing
        </h2>
        <span
          class="font-mono text-xs text-[var(--text-muted)] group-hover:text-[var(--text)] transition-colors duration-200"
        >
          ↗
        </span>
      </a>

      <div class="space-y-8">
        {
          recentPostsWithReadingTime.length > 0 ? (
            recentPostsWithReadingTime.map((post, i) => (
              <PostPreview
                title={post.data.title}
                description={post.data.description}
                publishDate={post.data.publishDate}
                slug={post.id}
                readingTime={post.minutesRead}
                index={i}
              />
            ))
          ) : (
            <p class="font-serif text-sm text-[var(--text-muted)] italic">
              No posts yet. Check back soon.
            </p>
          )
        }
      </div>
    </section>

    <!-- Projects Section -->
    <section class="mb-20 animate-fade-up stagger-5">
      <a 
        href="/projects"
        class="group flex items-baseline justify-between mb-8 -mx-2 px-2 py-1 rounded transition-colors duration-200 hover:bg-[var(--bg-paper)]"
      >
        <h2
          class="font-mono text-xs tracking-widest uppercase text-[var(--text-muted)] group-hover:text-[var(--text)] transition-colors duration-200"
        >
          Selected Work
        </h2>
        <span
          class="font-mono text-xs text-[var(--text-muted)] group-hover:text-[var(--text)] transition-colors duration-200"
        >
          ↗
        </span>
      </a>

      <div class="space-y-12">
        {
          featuredProjects.map((project) => (
            <article class="hover-lift p-4 -mx-4 rounded transition-all duration-300 hover:bg-[var(--bg-paper)]">
              <a
                href={`/projects/${project.id}`}
                class="group block"
              >
                <div class="flex items-baseline justify-between mb-2">
                  <h3 class="font-serif text-xl group-hover:underline decoration-1 underline-offset-4 transition-all duration-300">
                    {project.data.name}
                  </h3>
                  <span class="font-mono text-xs text-[var(--text-faint)]">
                    {project.data.year}
                  </span>
                </div>

                <p class="font-mono text-xs text-[var(--text-muted)] mb-3">
                  {project.data.description}
                </p>

                {project.data.awards && project.data.awards.length > 0 && (
                  <p class="font-mono text-[10px] text-[var(--text-faint)] mb-3 tracking-wide uppercase">
                    <span class="text-[var(--accent-pop)] opacity-70 mr-1">◆</span>
                    {formatAwards(project.data.awards)}
                  </p>
                )}

                <div class="overflow-hidden rounded border border-[var(--border)] transition-all duration-500 group-hover:border-[var(--text-muted)]">
                  <Image
                    src={project.data.coverImage.src}
                    alt={project.data.coverImage.alt}
                    class="w-full h-auto transition-transform duration-700 group-hover:scale-[1.02]"
                    widths={[400, 800]}
                    sizes="(max-width: 768px) 100vw, 700px"
                  />
                </div>
              </a>
            </article>
          ))
        }
      </div>
    </section>

    <!-- Contact -->
    <section class="mb-16 animate-fade-up stagger-6">
      <div class="p-6 rounded-sm bg-[var(--bg-paper)]">
        <p class="font-serif text-sm mb-4 text-[var(--text-muted)]">
          Please send me an email if you'd like to get in touch!
        </p>
        <div class="flex gap-4">
          <a href="/resume.pdf" class="font-mono text-xs link-underline">
            Resume
          </a>
          <a href="mailto:meimar@ualberta.ca" class="font-mono text-xs link-underline">
            Email
          </a>
        </div>
      </div>
    </section>

    <Footer />
  </div>
</Base>
